<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Tracker</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
      #videoCanvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      /* Left tool buttons */
      .tool-rail {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        padding: 8px 6px;
      }
      .tool-btn {
        width: 52px;
        height: 52px;
        padding: 0;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .tool-btn svg {
        width: 26px;
        height: 26px;
      }

      .tool-btn.bottom {
        width: 52px;
        height: 52px;
        padding: 0;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .tracker-btn {
        width: 52px;
        height: 52px;
        padding: 0;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .tracker-btn.active-tracker,
      .tracker-btn.active-tracker:hover,
      .tracker-btn.active-tracker:focus,
      .tracker-btn.active-tracker:active {
        outline: 3px solid #000000;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9);
      }
      .tracker-btn svg {
        width: 22px;
        height: 22px;
      }

      /* Left column width (rail + bottom button) */
      .left-tools {
        width: 72px; /* rail width + padding */
      }
    </style>
  </head>

  <body class="bg-light">
    {% extends "base.html" %} {% block title %}Image Tracker{% endblock %} {%
    block extra_head %}
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      /* Ensures the canvas always fills the available width */
      #videoCanvas {
        width: 100%;
        height: 100%;
        display: block;
      }
    </style>
    {% endblock %} {% block content %}
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
              <h4 class="card-title mb-0">Live Tracking Display</h4>
            </div>

            <div class="card-body">
              <div class="text-center mb-3">
                <!-- Left tools + responsive canvas area -->
                <div class="d-flex align-items-stretch gap-2">
                  <!-- LEFT COLUMN: rail on top, tracker button below -->
                  <div class="d-flex flex-column align-items-center left-tools">
                    <!-- TOOL RAIL -->
                    <div class="tool-rail rounded bg-white">
                      <!-- PLAY / PAUSE CONTROLS -->
                      <div class="d-flex flex-column gap-2 my-2">
                        <!-- PLAY -->
                        <button
                          type="button"
                          class="btn btn-outline-success tool-btn"
                          id="startBtn"
                          title="Play"
                          aria-label="Play"
                          disabled
                        >
                          <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            aria-hidden="true"
                          >
                            <path d="M8 5l10 7-10 7V5z" fill="currentColor" />
                          </svg>
                        </button>

                        <!-- PAUSE -->
                        <button
                          type="button"
                          class="btn btn-outline-danger tool-btn"
                          id="pauseBtn"
                          title="Pause"
                          aria-label="Pause"
                        >
                          <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            aria-hidden="true"
                          >
                            <path d="M7 5h4v14H7z" fill="currentColor" />
                            <path d="M13 5h4v14h-4z" fill="currentColor" />
                          </svg>
                        </button>
                      </div>
                      <!-- Arrow tool -->
                      <button
                        type="button"
                        class="btn btn-outline-secondary tool-btn"
                        id="toolArrow"
                        title="Arrow tool"
                        aria-label="Arrow tool"
                      >
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path
                            d="M5 12h12"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                          />
                          <path
                            d="M13 6l6 6-6 6"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          />
                        </svg>
                      </button>

                      <!-- Text tool -->
                      <button
                        type="button"
                        class="btn btn-outline-secondary tool-btn"
                        id="toolText"
                        title="Text tool"
                        aria-label="Text tool"
                      >
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path
                            d="M6 7V5h12v2"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                          />
                          <path
                            d="M12 5v14"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                          />
                          <path
                            d="M8 19h8"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                          />
                        </svg>
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-danger tool-btn mt-2"
                        id="deleteTrackerBtn"
                        title="Delete selected tracker"
                        aria-label="Delete selected tracker"
                      >
                        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                          <path
                            d="M3 6h18"
                            stroke="currentColor"
                            stroke-width="2"
                          />
                          <path
                            d="M8 6V4h8v2"
                            stroke="currentColor"
                            stroke-width="2"
                          />
                          <rect
                            x="6"
                            y="6"
                            width="12"
                            height="14"
                            rx="2"
                            stroke="currentColor"
                            stroke-width="2"
                          />
                          <path
                            d="M10 11v6M14 11v6"
                            stroke="currentColor"
                            stroke-width="2"
                          />
                        </svg>
                      </button>
                    </div>

                    <!-- BUTTON BELOW TOOL RAIL -->
                    <div
                      id="trackerButtonList"
                      class="d-flex flex-column gap-2 mt-2 mb-2"
                    ></div>
                    <button
                      type="button"
                      class="btn btn-outline-secondary tool-btn active bottom mt-auto"
                      id="toolTracker"
                      title="Add tracker"
                      aria-label="Add tracker"
                    >
                      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path
                          d="M12 5v14"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                        />
                        <path
                          d="M5 12h14"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                        />
                      </svg>
                    </button>
                  </div>

                  <!-- CANVAS AREA (RIGHT) -->
                  <div
                    class="ratio ratio-4x3 border rounded overflow-hidden flex-grow-1"
                  >
                    <canvas id="videoCanvas"></canvas>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-center mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="bboxToggle"
                    checked
                  />
                  <label class="form-check-label" for="bboxToggle">
                    Show bounding box
                  </label>
                </div>
              </div>

              <div class="alert alert-info" id="status" role="alert">
                Status: Ready
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white mt-5 py-4">
      <div class="container text-center">
        <p class="mb-0">&copy; 2026 McHacks. Built with Flask and Bootstrap.</p>
      </div>
    </footer>

    <script>
      const TARGET_W = 640;
      const TARGET_H = 480;

      const socket = io();
      const canvas = document.getElementById("videoCanvas");
      const ctx = canvas.getContext("2d");
      const startBtn = document.getElementById("startBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const statusDiv = document.getElementById("status");
      const deleteTrackerBtn = document.getElementById("deleteTrackerBtn");

      let addingArrow = false;

      let pendingArrowStart = null;

      let trackerCount = 0;
      const trackerButtons = [];
      let activeTracker = -1;

      const TRACKER_COLOURS_BGR = [
        [0, 255, 0], // Green
        [255, 0, 0], // Blue   (BGR -> RGB => 0,0,255)
        [0, 0, 255], // Red    (BGR -> RGB => 255,0,0)
        [255, 255, 0], // Cyan
        [255, 0, 255], // Magenta
        [0, 255, 255], // Yellow
        [255, 165, 0], // Orange
        [128, 0, 128], // Purple
      ];

      function trackerColorCss(idx) {
        const bgr = TRACKER_COLOURS_BGR[idx % TRACKER_COLOURS_BGR.length];
        const r = bgr[2],
          g = bgr[1],
          b = bgr[0]; // BGR -> RGB
        return `rgb(${r}, ${g}, ${b})`;
      }

      function readableTextColorForRgbString(rgbStr) {
        // rgb(r,g,b)
        const m = rgbStr.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (!m) return "#fff";
        const r = parseInt(m[1], 10),
          g = parseInt(m[2], 10),
          b = parseInt(m[3], 10);
        // simple luminance heuristic
        const lum = 0.2126 * r + 0.7152 * g + 0.0722 * b;
        return lum > 160 ? "#000" : "#fff";
      }

      function setStatus(msg) {
        statusDiv.textContent = "Status: " + msg;
      }

      function resizeCanvasToContainer() {
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;

        canvas.width = Math.round(rect.width * dpr);
        canvas.height = Math.round(rect.height * dpr);

        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }

      window.addEventListener("resize", resizeCanvasToContainer);
      resizeCanvasToContainer();

      socket.on("frame", (data) => {
        const img = new Image();
        img.onload = () => {
          const rect = canvas.getBoundingClientRect();
          ctx.clearRect(0, 0, rect.width, rect.height);
          ctx.drawImage(img, 0, 0, rect.width, rect.height);
        };
        img.src = "data:image/jpeg;base64," + data;
      });

      socket.on("status", (message) => {
        setStatus(message);
      });

      startBtn.addEventListener("click", () => {
        socket.emit("start_tracking");
        startBtn.disabled = true;
        pauseBtn.disabled = false;
        setStatus("Starting...");
      });

      pauseBtn.addEventListener("click", () => {
        socket.emit("pause_tracking");
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        setStatus("Pausing...");
      });

      const trackerButtonList = document.getElementById("trackerButtonList");

      function reindexTrackersUI() {
        trackerButtons.forEach((b, i) => {
          b.dataset.trackerIndex = String(i);
        });
      }

      // Create a green tracker button above the + button
      function addTrackerButton() {
        const btn = document.createElement("button");
        btn.type = "button";

        const idx = trackerButtons.length; // UI index = tracker_num
        const bg = trackerColorCss(idx);

        // Don't use btn-success (it will override your background)
        btn.className = "btn tracker-btn";
        btn.title = `Tracker ${idx + 1}`;
        btn.setAttribute("aria-label", `Tracker ${idx + 1}`);

        btn.style.backgroundColor = bg;
        btn.style.color = readableTextColorForRgbString(bg);

        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="12" r="2" fill="currentColor"/>
          </svg>
        `;

        trackerButtonList.appendChild(btn);
        trackerButtons.push(btn);

        btn.addEventListener("click", () => setActiveTracker(btn));
        setActiveTracker(btn);

        trackerCount = trackerButtons.length; // keep consistent if you still use it elsewhere
      }

      canvas.addEventListener("click", (e) => {
        const rect = canvas.getBoundingClientRect();
        const cssX = e.clientX - rect.left;
        const cssY = e.clientY - rect.top;

        const trackX = Math.round((cssX / rect.width) * TARGET_W);
        const trackY = Math.round((cssY / rect.height) * TARGET_H);

        // If "+" tool is active, treat this click as "add tracker"
        const isAddTrackerMode = document
          .getElementById("toolTracker")
          .classList.contains("active");
        const isAddArrowMode = document
          .getElementById("toolArrow")
          .classList.contains("active");
        const isAddTextMode = document
          .getElementById("toolText")
          .classList.contains("active");

        if (!isAddArrowMode) {
          addingArrow = false;
        }

        if (isAddTrackerMode) {
          // Create the UI button
          addTrackerButton();

          setStatus(`Added tracker at (${trackX}, ${trackY})`);

          // Otherwise normal behavior
          socket.emit("select_point", { x: trackX, y: trackY });
        } else if (isAddArrowMode) {
          if (!addingArrow) {
            setStatus(`Arrow tool clicked at (${trackX}, ${trackY})`);
            start = { x: trackX, y: trackY };
            addingArrow = true;
          } else {
            setStatus(`Arrow tool clicked at (${trackX}, ${trackY})`);
            end = { x: trackX, y: trackY };
            addingArrow = false;

            socket.emit("add_arrow", {
              tracker_num: activeTracker,
              start: start,
              end: end,
            });
          }
        } else {
          setStatus(`Text tool clicked at (${trackX}, ${trackY})`);
          const userText = prompt("Enter text to add:");
          if (userText) {
            socket.emit("add_text", {
              tracker_num: activeTracker,
              x: trackX,
              y: trackY,
              text: userText,
            });
          }
        }
      });

      const bboxToggle = document.getElementById("bboxToggle");
      bboxToggle.addEventListener("change", () => {
        socket.emit("toggle_bbox", { show: bboxToggle.checked });
      });

      const toolButtons = [
        document.getElementById("toolArrow"),
        document.getElementById("toolText"),
        document.getElementById("toolTracker"),
      ];

      function setActiveTool(btn) {
        toolButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        if (btn.id !== "toolArrow") {
          pendingArrowStart = null;
        }
      }

      function setActiveTracker(btn) {
        trackerButtons.forEach((b) => b.classList.remove("active-tracker"));
        btn.classList.add("active-tracker");
        activeTracker = trackerButtons.indexOf(btn);
        reindexTrackersUI();
      }

      toolButtons.forEach((btn) => {
        btn.addEventListener("click", () => setActiveTool(btn));
      });

      deleteTrackerBtn.addEventListener("click", () => {
        if (activeTracker === -1) {
          setStatus("No tracker selected");
          return;
        }

        const idx = activeTracker;
        console.log("Deleting tracker", idx);

        // Tell server to delete tracker idx
        socket.emit("delete_tracker", { tracker_num: idx });

        // Update UI immediately (optimistic)
        const removedBtn = trackerButtons.splice(idx, 1)[0];
        if (removedBtn) removedBtn.remove();

        // Choose a new active tracker (same index if exists, else previous)
        if (trackerButtons.length === 0) {
          activeTracker = -1;
        } else {
          const newIdx = Math.min(idx, trackerButtons.length - 1);
          setActiveTracker(trackerButtons[newIdx]);
        }

        reindexTrackersUI();
        setStatus(`Deleted tracker ${idx}`);
      });

      socket.on("connect", () => {
        socket.emit("end_thread");
      });
    </script>
    {% endblock %}
  </body>
</html>
